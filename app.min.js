function node(a){this.id=a.id,this.x=a.x,this.y=a.y,this.content=a.content}function link(a){this.id=a.id,this.src=a.src,this.dest=a.dest,this.label=a.label,this.left=a.left,this.right=a.right}function update(){var a=document.getElementById("content").value;if(selected_node){var b=nodes.indexOf(selected_node);nodes[b].content=a}else{var b=links.indexOf(selected_link);links[b].label=a,document.getElementById(selected_link.id).textContent=a}}function save(){var a=[];nodes.map(function(b){a.push(JSON.stringify(b)),a.push("\n")}),links.map(function(b){a.push(JSON.stringify(b)),a.push("\n")});var b=new Blob(a,{type:"text/plain;charset=utf-8"});saveAs(b,"test2.txt")}function load(a){var b=a.files[0];if(b){var c=new FileReader;c.readAsText(b),c.onload=function(a){nodes.length=0,links.length=0,draw();var b=a.target.result,c=b.split("\n").filter(function(a){return a.length>0});c.map(function(a){var b=JSON.parse(a);4===Object.keys(b).length?nodes.push(new node(b)):links.push(new link(b))}),draw()}}else console.log("fail to load file")}function removenode(a){nodes=nodes.filter(function(b){return b!=a}),links=links.filter(function(b){return b.src!=a&&b.dest!=a})}function removelink(a){links=links.filter(function(b){return b!=a})}function exist(a){for(var b=links.length,c=0;b>c;c++)if(links[c].id===a)return!0;return!1}function getd(a,b){var c=b.x-a.x,d=b.y-a.y,e=Math.sqrt(c*c+d*d),f=c/e,g=d/e;return"M"+(a.x+r*f)+","+(a.y+r*g)+"L"+(b.x-r*f)+","+(b.y-r*g)}function keyup(){if(d3.event.preventDefault(),selected_node||selected_link)switch(d3.event.keyCode){case 46:selected_node?confirm("delete node "+selected_node.id+"?")&&(removenode(selected_node),selected_node=null,draw()):selected_link&&confirm("delete link "+selected_link.id+"?")&&(removelink(selected_link),selected_link=null,draw());break;case 17:circle.on("mousedown.drag",!1),createPaths([]),createPaths(links)}}function keydown(){selected_node&&17===d3.event.keyCode&&circle.call(drag)}function createPaths(a){path=path.data(a,function(a){return a.id});var b=path.enter().append("svg:g");b.append("svg:path").attr("class","link").attr("d",function(a){return getd(a.src,a.dest)}).style("marker-start",function(a){return a.left?"url(#start-arrow)":""}).style("marker-end",function(a){return a.right?"url(#end-arrow)":""}).on("click",function(a){selected_link=a,selected_node=null,document.getElementById("content").value=a.label,d3.selectAll("path").classed("selected",function(a){return a===selected_link})}),b.append("svg:text").attr("id",function(a){return a.id}).attr("class","id").attr("transform",function(a){return"translate("+[(a.src.x+a.dest.x)/2,(a.src.y+a.dest.y)/2]+")"}).attr("x",20).text(function(a){return a.label}),path.exit().remove()}function createNodes(){circle=circle.data(nodes,function(a){return a.id}),circle.classed("reflexive",function(a){return a===selected_node});var a=circle.enter().append("svg:g").attr("transform",function(a){return"translate("+[a.x,a.y]+")"}).on("mousedown",function(a){selected_node=a,selected_link=null,ismousedown=!0,drag_line.style("marker-end","url(#end-arrow)"),isdone=!1,console.log("current node now is "+selected_node.id),d3.selectAll("circle").classed("reflexive",function(a){return a===selected_node}),document.getElementById("content").value=selected_node.content}).on("mouseover",function(a){if(ismouseovernode=!0,selected_node&&selected_node!=a&&ismousedown&&!isdone){drag_line.style("marker-end","url(#end-arrow)");var b=selected_node.id+"-"+a.id;if(!exist(b)){drag_line.classed("hidden",!0),isdone=!0;var c=new link({id:b,src:selected_node,dest:a,label:"YES",left:!1,right:!0});links.push(c),selected_link=c,draw()}console.log(links)}else drag_line.style("marker-start","url(#start-arrow)")}).on("mouseout",function(){ismouseovernode=!1});a.append("svg:circle").attr("r",r).attr("class","node").style("fill",function(a){return d3.rgb(colors(a.id)).brighter().toString()}).style("stroke",function(a){return d3.rgb(colors(a.id)).darker().toString()}),a.append("svg:text").attr("y",function(){return 4}).attr("class","id").text(function(a){return a.id}),circle.exit().remove()}function draw(){createNodes(),createPaths(links)}var width="100%",height=1e3,colors=d3.scale.category10(),r=20,nodes=[new node({id:1,x:50,y:50,content:"content of node 1"}),new node({id:2,x:100,y:100,content:"content of node 2"})],links=[new link({id:"1-2",src:nodes[0],dest:nodes[1],label:"START",left:!1,right:!0})],maxid=nodes.length,ismousedown=!1,selected_link=null,isdone=!1,ismouseovernode=!1,selected_node=nodes[0],svg=d3.select("body").append("svg").attr("width",width).attr("height",height).on("mousemove",function(){ismousedown&&(drag_line.classed("hidden",!1),drag_line.attr("d","M"+selected_node.x+","+selected_node.y+"L"+d3.mouse(this)[0]+","+d3.mouse(this)[1]))}).on("mouseup",function(){ismousedown=!1,drag_line.classed("hidden",!0)}).on("dblclick",function(){if(!ismouseovernode){var b=d3.mouse(this),c=++maxid,d=new node({id:c,x:b[0],y:b[1],content:"this is the content of node "+c});selected_node=d,selected_link=null,nodes.push(d),draw()}});svg.append("svg:defs").append("svg:marker").attr("id","end-arrow").attr("viewBox","0 -5 10 10").attr("refX",6).attr("markerWidth",3).attr("markerHeight",3).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5").attr("fill","#000"),svg.append("svg:defs").append("svg:marker").attr("id","start-arrow").attr("viewBox","0 -5 10 10").attr("refX",4).attr("markerWidth",3).attr("markerHeight",3).attr("orient","auto").append("svg:path").attr("d","M10,-5L0,0L10,5").attr("fill","#000");var drag=d3.behavior.drag().on("drag",function(a){a.x+=d3.event.dx,a.y+=d3.event.dy,d3.select(this).attr("transform",function(a){return"translate("+[a.x,a.y]+")"})}),circle=svg.append("svg:g").selectAll("circle"),path=svg.append("svg:g").selectAll("path"),drag_line=svg.append("svg:path").attr("class","link dragline hidden").attr("d","M0,0L0,0");d3.select(window).on("keyup",keyup).on("keydown",keydown),draw();